<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EZP â€” Insights</title>

<link rel="stylesheet" href="common.css">
</head>
<body>

<div class="container">
  <header>
    <h1>Insights</h1>
    <div class="small">Real-time zone parking analytics</div>
  </header>

  <div class="card" style="margin-top:18px;display:flex;gap:18px;align-items:center">

    <!-- DONUT -->
    <div style="flex:0 0 180px;text-align:center">
      <div id="donut" style="width:140px;height:140px;border-radius:50%;display:grid;place-items:center;background:conic-gradient(var(--accent) var(--p,0deg), rgba(255,255,255,0.06) 0)">
        <div id="donutText" style="width:84px;height:84px;border-radius:50%;background:var(--panel);display:grid;place-items:center;font-weight:800">
          0%
        </div>
      </div>
      <div class="small" style="margin-top:8px">Occupied</div>
    </div>

    <!-- RIGHT -->
    <div style="flex:1">
      <div class="small">Current Occupancy by Building</div>
      <div id="hourPreview" style="margin-top:8px"></div>
    </div>

  </div>
</div>

<!-- bottom nav -->
<div class="bottom-nav">
  <button class="nav-btn" data-page="home" onclick="location='./home.html'">Home</button>
  <button class="nav-btn" data-page="alerts" onclick="location='./alerts.html'">Alerts</button>
  <button class="nav-btn active" data-page="insights">Insights</button>
  <button class="nav-btn" data-page="settings" onclick="location='./settings.html'">Settings</button>
</div>

<script>


// Load buildings
async function loadBuildings(){
  const r = await fetch(API + "/buildings");
  return r.json();
}

// Load building status
async function loadStatus(id){
  const r = await fetch(API + "/buildings/" + id + "/status");
  return r.json();
}

async function renderInsights(){
  const buildings = await loadBuildings();

  let totalSlots = 0;
  let totalOcc = 0;

  const rows = [];

  for(const b of buildings){
    const stat = await loadStatus(b.id);
    totalSlots += stat.total;
    totalOcc += stat.occupied;

    const pct = stat.total ? Math.round((stat.occupied / stat.total) * 100) : 0;

    rows.push({
      name: b.name,
      pct
    });
  }

  // ---- DONUT ----
  const zonePct = totalSlots ? Math.round((totalOcc / totalSlots) * 100) : 0;
  document.getElementById("donut").style.setProperty("--p", Math.round(360 * zonePct / 100) + "deg");
  document.getElementById("donutText").textContent = zonePct + "%";

  // ---- LIST ----
  const container = document.getElementById("hourPreview");
  container.innerHTML = "";

  rows.forEach(r => {
    const el = document.createElement("div");
    el.style.display = "flex";
    el.style.alignItems = "center";
    el.style.gap = "12px";
    el.style.marginTop = "10px";

    el.innerHTML = `
      <div style="width:140px" class="small">${r.name}</div>
      <div style="flex:1;height:10px;border-radius:8px;background:rgba(255,255,255,0.04);overflow:hidden">
        <div style="width:${r.pct}%;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2))"></div>
      </div>
      <div style="width:44px;text-align:right" class="small">${r.pct}%</div>
    `;

    container.appendChild(el);
  });

  // nav highlight
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.page === 'insights'));
}
(function applySavedSettings(){
  const APPEAR_KEY = "ezp_appearance";
  const ACCENT_KEY = "ezp_accent";

  const mode = localStorage.getItem(APPEAR_KEY) || "system";
  const accent = localStorage.getItem(ACCENT_KEY) || "#13b5d3";

  // apply accent
  document.documentElement.style.setProperty("--accent", accent);

  // apply appearance
  if(mode === "dark"){
    document.documentElement.style.colorScheme = "dark";
  } else if(mode === "light"){
    document.documentElement.style.colorScheme = "light";
  } else {
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    document.documentElement.style.colorScheme = prefersDark ? "dark" : "light";
  }
})();
// initial + auto refresh
renderInsights();
setInterval(renderInsights, 5000);
</script>

</body>
</html>
