<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EZP â€” Alerts</title>

<link rel="stylesheet" href="common.css">
</head>
<body>

<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:flex-start">
    <div>
      <h1>Alerts</h1>
      <div class="small">Get notified when spots become available</div>
    </div>
    <div>
      <button class="chip" id="addAlert">+</button>
    </div>
  </div>

  <div class="card" style="margin-top:18px">
    <div id="alertsContainer"></div>
  </div>
</div>

<div class="bottom-nav">
  <button class="nav-btn" data-page="home" onclick="location='./home.html'">Home</button>
  <button class="nav-btn active" data-page="alerts">Alerts</button>
  <button class="nav-btn" data-page="insights" onclick="location='./insights.html'">Insights</button>
  <button class="nav-btn" data-page="settings" onclick="location='./settings.html'">Settings</button>
</div>

<script>


// Load alerts from backend
async function loadAlerts(){
  const r = await fetch(API + "/alerts");
  return r.json();
}

// Render alerts
async function renderAlerts(){
  const c = document.getElementById("alertsContainer");
  const arr = await loadAlerts();

  if(arr.length === 0){
    c.innerHTML = '<div class="small">No alerts yet â€” click + to add one.</div>';
    return;
  }

  c.innerHTML = "";

  arr.forEach(a => {
    const row = document.createElement("div");
    row.className = "alert-item";

    row.innerHTML = `
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div class="badge">${a.slot_code}</div>
        <div>
          <div style="font-weight:700">Slot ${a.slot_code}</div>
          <div class="small">Notify when free</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div class="toggle ${a.enabled ? 'on' : ''}" data-id="${a.id}">
          <div class="knob"></div>
        </div>
        <div class="icon-btn" data-del="${a.id}">ðŸ—‘</div>
      </div>
    `;

    c.appendChild(row);
  });

  // Toggle
  document.querySelectorAll(".toggle").forEach(t => {
    t.onclick = async () => {
      await fetch(API + "/alerts/" + t.dataset.id + "/toggle", { method: "PUT" });
      renderAlerts();
    };
  });

  // Delete
  document.querySelectorAll("[data-del]").forEach(b => {
    b.onclick = async () => {
      await fetch(API + "/alerts/" + b.dataset.del, { method: "DELETE" });
      renderAlerts();
    };
  });
}

// Add alert
document.getElementById("addAlert").onclick = async () => {
  const slotId = prompt("Enter SLOT ID (example: 1, 2, 3...)");
  if(!slotId) return;

  await fetch(API + "/alerts", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ slot_id: slotId })
  });

  renderAlerts();
};

// Init
renderAlerts();
setInterval(renderAlerts, 5000);
</script>

</body>
</html>
